#!/usr/bin/env ruby

require 'json'
require 'fileutils'

# Script for auto-release: extract version from CHANGELOG, update init.rb, tag, prepare next version

changelog_path = File.join(__dir__, '..', 'CHANGELOG.md')
init_path = File.join(__dir__, '..', 'init.rb')

# Extract latest version from CHANGELOG.md
changelog_content = File.read(changelog_path)
version_match = changelog_content.match(/## Version: ([\d.]+)/)

unless version_match
  puts "ERROR: Could not find version in CHANGELOG.md"
  exit 1
end

current_version = version_match[1]
puts "Found version in CHANGELOG: #{current_version}"

# Update init.rb with new version
init_content = File.read(init_path)
updated_init = init_content.gsub(/version '[^']*'/, "version '#{current_version}'")

if init_content == updated_init
  puts "WARNING: init.rb already has version #{current_version}"
else
  File.write(init_path, updated_init)
  puts "Updated init.rb to version #{current_version}"
end

# Calculate next version (increment patch)
version_parts = current_version.split('.')
version_parts[-1] = (version_parts[-1].to_i + 1).to_s
next_version = version_parts.join('.')

# Prepare next version entry in CHANGELOG.md
new_changelog_entry = "## Version: #{next_version}\n### Improvements\n- \n\n"
updated_changelog = new_changelog_entry + changelog_content

File.write(changelog_path, updated_changelog)
puts "Added new entry to CHANGELOG.md for version #{next_version}"

# Git operations
system('git', 'config', 'user.email', 'action@github.com') or raise "Failed to set git email"
system('git', 'config', 'user.name', 'GitHub Action') or raise "Failed to set git name"

system('git', 'add', init_path, changelog_path) or raise "Failed to add files"
system('git', 'commit', '-m', "Release version #{current_version}") or raise "Failed to commit"
system('git', 'tag', current_version) or raise "Failed to create tag"

system('git', 'push', 'origin', 'HEAD:master') or raise "Failed to push commit"
system('git', 'push', 'origin', current_version) or raise "Failed to push tag"

puts "Release #{current_version} completed successfully!"
puts JSON.generate({
  status: "success",
  version: current_version,
  next_version: next_version
})
