#!/usr/bin/env ruby

require 'json'
require 'fileutils'

# Script for auto-release: extract version from CHANGELOG, update init.rb, tag, prepare next version

changelog_path = File.join(__dir__, '..', 'CHANGELOG.md')
init_path = File.join(__dir__, '..', 'init.rb')

# Extract latest version from CHANGELOG.md
changelog_content = File.read(changelog_path)
version_match = changelog_content.match(/## Version: ([\d.]+)/)

unless version_match
  puts "ERROR: Could not find version in CHANGELOG.md"
  exit 1
end

current_version = version_match[1]
puts "Found version in CHANGELOG: #{current_version}"

# Validate that current version entry is complete (doesn't have placeholder)
next_version_match = changelog_content.match(/## Version: #{Regexp.escape(current_version)}\n(.*?)\n(?:## Version:|$)/m)
current_version_entry = next_version_match[1] if next_version_match

if current_version_entry && current_version_entry.include?('Prepare for next release')
  puts "ERROR: CHANGELOG for version #{current_version} contains 'Prepare for next release' placeholder"
  puts "Please complete the changelog entry before releasing"
  exit 1
end

if current_version_entry && current_version_entry.strip.empty?
  puts "ERROR: CHANGELOG for version #{current_version} is empty"
  puts "Please add release notes before merging"
  exit 1
end

puts "Validated CHANGELOG entry for #{current_version}"

# Update init.rb with new version
init_content = File.read(init_path)
updated_init = init_content.gsub(/version '[^']*'/, "version '#{current_version}'")

if init_content == updated_init
  puts "WARNING: init.rb already has version #{current_version}"
else
  File.write(init_path, updated_init)
  puts "Updated init.rb to version #{current_version}"
end

# Calculate next version (increment patch)
version_parts = current_version.split('.')
version_parts[-1] = (version_parts[-1].to_i + 1).to_s
next_version = version_parts.join('.')

# Prepare next version entry in CHANGELOG.md
# Ensure # Changelog header stays at top
if changelog_content.start_with?("# Changelog\n")
  header = "# Changelog\n"
  rest_of_changelog = changelog_content[header.length..-1]

  new_changelog_entry = <<~CHANGELOG
    ## Version: #{next_version}
    ### Improvements
    - Prepare for next release

    CHANGELOG

  updated_changelog = header + new_changelog_entry + rest_of_changelog
else
  puts "ERROR: CHANGELOG.md must start with '# Changelog' header"
  exit 1
end

File.write(changelog_path, updated_changelog)
puts "Added new entry to CHANGELOG.md for version #{next_version}"

# Git operations
system('git', 'config', 'user.email', 'action@github.com') or raise "Failed to set git email"
system('git', 'config', 'user.name', 'GitHub Action') or raise "Failed to set git name"

system('git', 'add', init_path, changelog_path) or raise "Failed to add files"
system('git', 'commit', '-m', "Release version #{current_version}") or raise "Failed to commit"
system('git', 'tag', "release_#{current_version}") or raise "Failed to create tag"

system('git', 'push', 'origin', 'HEAD:master') or raise "Failed to push commit"
system('git', 'push', 'origin', "release_#{current_version}") or raise "Failed to push tag"

puts "Release #{current_version} completed successfully!"
puts JSON.generate({
  status: "success",
  version: current_version,
  next_version: next_version
})
