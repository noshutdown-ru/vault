<% html_title(t('label_module')) %>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag "font-awesome.min.css", :plugin => "vault" %>
  <%= javascript_include_tag 'vault', :plugin => 'vault' %>
<% end %>

<div class="contextual">
</div>

<h2 class="keys-search-title">
  <%= t('key.title.list') %>
</h2>

<%= form_tag({}) do %>
<table class='list' id='keys_table'>
    <thead>
    <tr>
      <th class="checkbox hide-when-print">
        <%= check_box_tag 'check_all', '', false, :class => 'toggle-selection',
                          :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}" %>
      </th>
      <th style="padding: 4px;">
        <%= text_field_tag(:filter_project, '',
          { id: 'filter-project', class: 'filter-text', placeholder: t('key.attr.project'), style: 'width: 100%; box-sizing: border-box; padding: 4px; border: 1px solid #ddd;' }) %>
      </th>
      <th style="padding: 4px;">
        <%= text_field_tag(:filter_type, '',
          { id: 'filter-type', class: 'filter-text', placeholder: t('key.attr.type'), style: 'width: 100%; box-sizing: border-box; padding: 4px; border: 1px solid #ddd;' }) %>
      </th>
      <th style="padding: 4px;">
        <%= text_field_tag(:filter_name, '',
          { id: 'filter-name', class: 'filter-text', placeholder: t('key.attr.name'), style: 'width: 100%; box-sizing: border-box; padding: 4px; border: 1px solid #ddd;' }) %>
      </th>
      <th style="padding: 4px;">
        <%= text_field_tag(:filter_url, '',
          { id: 'filter-url', class: 'filter-text', placeholder: t('key.attr.url'), style: 'width: 100%; box-sizing: border-box; padding: 4px; border: 1px solid #ddd;' }) %>
      </th>
      <th style="padding: 4px;">
        <%= text_field_tag(:filter_login, '',
          { id: 'filter-login', class: 'filter-text', placeholder: t('key.attr.login'), style: 'width: 100%; box-sizing: border-box; padding: 4px; border: 1px solid #ddd;' }) %>
      </th>
      <th style="padding: 4px;">
        <%= text_field_tag(:filter_body, '',
          { id: 'filter-body', class: 'filter-text', placeholder: t('key.attr.body'), style: 'width: 100%; box-sizing: border-box; padding: 4px; border: 1px solid #ddd;' }) %>
      </th>
      <th><%= t('key.btn.actions') %></th>
    </tr>
    </thead>
    <tbody>
    <% @keys.each do |key| %>
      <% if key.is_a?(Vault::Password) %>
        <%= render partial: 'vault/passwords/password_all', locals: {password: key, parity: cycle('odd', 'even')} %>
      <% elsif key.is_a?(Vault::Sftp) %>
        <%= render partial: 'vault/sftps/sftp_all', locals: {sftp: key, parity: cycle('odd', 'even')} %>
      <% elsif key.is_a?(Vault::KeyFile) %>
        <%= render partial: 'vault/key_files/key_file_all', locals: {key_file: key, parity: cycle('odd', 'even')} %>
      <% end %>
    <% end %>
    </tbody>
  </table>
<% end %>

<span class='pagination'>
  <%= pagination_links_full @key_pages, @key_count %>
</span>

<% other_formats_links do |f| %>
  <%= f.link_to_with_query_parameters t('export.title.pdf') %>
<% end %>

<% content_for :sidebar do %>
  <h3><%= t('tag.title.popular') %></h3>
  <div id='tags-list'>
    <ul>
      <% Vault::Tag.all.each do |t| %>
        <li class='vault-tag' style='background-color: <%= Vault::Tag.get_color(t.name) %>;'>
          <%= link_to t.name, {query: "##{t.name}"}, class: 'vault-tag-link' %>
        </li>
      <% end %>
    </ul>
  </div>
<% end %>

<script type="text/javascript">
  $('a[href^="http://"]').attr('target','_blank');
  $('a[href^="https://"]').attr('target','_blank');

  // Copy to clipboard functionality
  document.body.addEventListener('click', function(e) {
    var li = e.target.closest('li[data-copytarget]');
    if (li) {
      e.preventDefault();
      var copytarget = li.dataset.copytarget;
      var inp = copytarget ? document.querySelector(copytarget) : null;
      if (inp && inp.value) {
        try {
          inp.select();
          inp.setSelectionRange(0, inp.value.length);
          document.execCommand('copy');
          inp.blur();
        } catch (err) {
          console.error('Copy failed:', err);
        }
      }
    }
  }, true);

  // Client-side filtering for all columns (case-insensitive)
  function applyFilters() {
    var filters = {
      'filter-project': { selector: 'td:nth-child(2)', value: '' },
      'filter-type': { selector: 'td:nth-child(3)', value: '' },
      'filter-name': { selector: 'td:nth-child(4)', value: '' },
      'filter-url': { selector: 'td:nth-child(5)', value: '' },
      'filter-login': { selector: 'td:nth-child(6)', value: '' },
      'filter-body': { selector: 'td:nth-child(7)', value: '' }
    };

    // Get all filter values
    Object.keys(filters).forEach(function(filterId) {
      var elem = document.getElementById(filterId);
      if (elem) {
        filters[filterId].value = elem.value.toLowerCase().trim();
      }
    });

    var rows = document.querySelectorAll('table.list tbody tr');
    rows.forEach(function(row) {
      var matches = true;

      // Check each filter
      Object.keys(filters).forEach(function(filterId) {
        var filter = filters[filterId];
        if (filter.value) {
          var cell = row.querySelector(filter.selector);
          var text = cell ? cell.innerText.toLowerCase().trim() : '';
          if (!text.includes(filter.value)) {
            matches = false;
          }
        }
      });

      row.style.display = matches ? '' : 'none';
    });
  }

  // Add event listeners to all filter fields
  ['filter-project', 'filter-type', 'filter-name', 'filter-url', 'filter-login', 'filter-body'].forEach(function(filterId) {
    var elem = document.getElementById(filterId);
    if (elem) {
      elem.addEventListener('input', applyFilters);
    }
  });
</script>
